// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "forge-std/Test.sol";
import "../src/Ostraka.sol";
import "../lib/eas-contracts/contracts/ISchemaRegistry.sol";
import "eas-contracts/IEAS.sol";
import "forge-std/console.sol";

contract OstrakaExposed is Ostraka {
    constructor(IWorldID _worldId, IEAS _eas, bytes32 _schema_uid) public Ostraka(_worldId, _eas, _schema_uid) {}

    function exposedVote(bytes memory sismoMessage) external {
        _vote(sismoMessage);
    }

    function exposedAttestVote(bytes memory data) external returns (bytes32) {
        return attestVote(data);
    }
}

contract OstrakaTest is Test {
    OstrakaExposed public ostraka;
    string url = "https://www.google.com";

    function setUp() public {
        vm.createSelectFork(vm.rpcUrl("optimism_testnet"));
        IWorldID worldId = IWorldID(0xFc1315089316FcFe586a8E0a92873c258De8aaC1);
        IEAS eas = IEAS(0x1a5650D0EcbCa349DD84bAFa85790E3e6955eb84);

        // Register our schema to EAS schema registry
        // Also optimism address
        ISchemaRegistry schemaRegistry = ISchemaRegistry(0x7b24C7f8AF365B4E308b6acb0A7dfc85d034Cb3f);
        ISchemaResolver resolver;
        string memory schema = "bool signall, string content";
        bytes32 schema_uid = schemaRegistry.register(schema, resolver, false);

        ostraka = new OstrakaExposed(worldId, eas, schema_uid);
    }

    function testVote() public {
        // Encode signal and content into a sismo message
        bytes memory sismoMessage = abi.encode(true, url);
        bytes memory sismoMessage2 = abi.encode(false, url);

        // Call the vote
        ostraka.exposedVote(sismoMessage);
        ostraka.exposedVote(sismoMessage);
        ostraka.exposedVote(sismoMessage2);

        // Check the voting pools
        VotingPool memory pool = ostraka.getVotingPool(url);

        assertEq(pool.positiveVotes, 2);
        assertEq(pool.negativeVotes, 1);
        assertEq(pool.content, url);
    }

    function testWithFrontendData() public {
        // Encode signal and content into a sismo message
        bytes memory sismoConnectResponse =
            hex"00000000000000000000000000000000000000000000000000000000000000204a4e9fbd4e3e4d58a57a504a40611c8500000000000000000000000000000000b8e2054f8a912367e38a22ce773328ff000000000000000000000000000000007369736d6f2d636f6e6e6563742d76312e31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000961736461736461736400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000005400000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000ec000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001a068796472612d73332e310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000004a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010d600ea3f3305f6eb3c0032d61575517d4768cf470396615136194e1967a560900000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c02f070030fadbf7c67158d2bf7f2234da37961ac1279047c6bd24c8d92d8bb28b0d07082e93559a9e24e8e944c95d6c3e2b19201c52102fa26f7a86b76bda1e352582f7ae7b6b95b05a0d7b9c753fdc9ac8cb8fc0903b8adb6e70dd7787be523617d1c499ad0a97c7cb00086b4d9c94540ce767a2175d2002c2476f369437282412657b4dbbd14cfe0addd43db7f398db137de779376ef0163b93ce6f17eed4c908d63d4dc4907d288267829be2cae0230598216767066b74e6ccd610086ec0db21db1c5ef5aec98fe6013fb66ba99567dc162543f8d181528a98a4752f46ff6a114179b78df789c32c57d5aaef947693560f2b306df1f14e02cc141ebe67306900000000000000000000000000000000000000000000000000000000000000000234f700a24e593a9828d5aa89a55acaf5dc4102f2148f274904c3e0f1e5eebd1801b584700a740f9576cc7e83745895452edc518a9ce60b430e1272fc4eb93b057cf80de4f8dd3e4c56f948f40c28c3acbeca71ef9f825597bf8cc059f1238b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d600ea3f3305f6eb3c0032d61575517d4768cf470396615136194e1967a56091f707f0e1aa2bedd11dd4421397dbcf496b60ae3e8aabb10fd840b8b0bf2070a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001a068796472612d73332e310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000004a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000008ab1760889f26cbbf33a75fd2cf1696bfccdc9e600000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c0105e8e2f2a99a176ec36ed05e5a22ec1157386d9a2655a7d8683df070823998f19c08cb3b73902baf8a3b4d26465464cc3dfa8f75d6e828fb8a05432535f616a2d9c530fb1f324dae6384d0530a3e04fbf296a82bf21f925a2013c8b5a989fdf0b25896303f5b0d5d444acaf19b84057b3167c682c619c43ae0294dff3d82ae820837f589b22d8367f5e9571d96e4e454b757c3602b8647dfe37f72017db226b0df44b003a719b8a29644a448c150b38b61ccb7c7ba37eaa30f07d1d3c7c354e0a2090500e4a5f97314cfc16d3a72abce2ad38c16b66a1f6a00b0a642115f89f07c86664cda8eab5ae6ca11df72cb7762fdd1746c55df32cc4f39ba5de20698d0000000000000000000000008ab1760889f26cbbf33a75fd2cf1696bfccdc9e60234f700a24e593a9828d5aa89a55acaf5dc4102f2148f274904c3e0f1e5eebd1801b584700a740f9576cc7e83745895452edc518a9ce60b430e1272fc4eb93b057cf80de4f8dd3e4c56f948f40c28c3acbeca71ef9f825597bf8cc059f1238b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d600ea3f3305f6eb3c0032d61575517d4768cf470396615136194e1967a56091f707f0e1aa2bedd11dd4421397dbcf496b60ae3e8aabb10fd840b8b0bf2070a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001a068796472612d73332e310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000004a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000100200000000000000000000000000239070398000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c0019c86667f5303009725c900d46fb18c5a3314660a95772b501472fd172578f01d3eb1a58e23874f4785f4dcabb828a7e2788f1db51a193f33c3d5e51ed04dc92224979665ce26ca52fbd504cf0a1b975797188cdf7f83a7c61b8d59208370ee2e65b5d0d87fa5226b9a88e86755c96b388a7d5eb28482109567ced690c76c5e2ba84dc878714152baddec10bd47d37bc67b43182cb6af3b9f0ae928665fc1f0244cc196b3ae45918bd9d70cd4b01f53c1c83a34d66facc0454e0bd1b063e9540fe44163db8609471fbfb379404b74557db651f3b0f2aea8b1d394d9ae1bac63218f23bcdcc8c12309009c646954decea6db207f9673b6ad3c799e97cb0d036800000000000000000000000010020000000000000000000000000023907039800234f700a24e593a9828d5aa89a55acaf5dc4102f2148f274904c3e0f1e5eebd1801b584700a740f9576cc7e83745895452edc518a9ce60b430e1272fc4eb93b057cf80de4f8dd3e4c56f948f40c28c3acbeca71ef9f825597bf8cc059f1238b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d600ea3f3305f6eb3c0032d61575517d4768cf470396615136194e1967a56091f707f0e1aa2bedd11dd4421397dbcf496b60ae3e8aabb10fd840b8b0bf2070a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000c068796472612d73332e310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000004c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000b4bc5aaa69446c7901aaadc88d964414000000000000000000000000000000006c617465737400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c00f22ad476760f767894a6d0808ee718a573f31e0fd0c359782ed732f640b47421a59b513eda4c53fa4c309e54fdb0589c805fb4a31309871d62000055076c16020588eed42ca9d207c1fe756e8ee3085e7e89887adff441be945ee4edb11c1bf2080f47a109b47a2cde6660448a8bc8779263355ff6bad5b430b2d3d27412f60251f440a8222aa546469f8ce8cfea4ea57c0894d9210200dcc9dd757a8848bc410ebd3a1da4b300489a1d2a8e62fb026fd00cbc8065b75f7d6773e6b9b0d8d7a277f8650e544aed15634e2fd879fc6ce239aa6cd87e51fe61afe8086029b833b2cd2f72ea13e93a362cc7d3559d8cf7f6f4ef28fb67909e944e214956ce5852300000000000000000000000000000000000000000000000000000000000000000234f700a24e593a9828d5aa89a55acaf5dc4102f2148f274904c3e0f1e5eebd1801b584700a740f9576cc7e83745895452edc518a9ce60b430e1272fc4eb93b057cf80de4f8dd3e4c56f948f40c28c3acbeca71ef9f825597bf8cc059f1238b1424893a36f6fe8222e8d33aaac4c646b686d66fa78a4ca42b4f93dca0a02721096bb97160eb5ccc78a951c7548b7ec7ec170f033dad4ed1828db07c301461d523975e8c05a26a0b0feb5a43fbf0703dceb21703466e0ee26c74a343a22ec2830000000000000000000000000000000000000000000000000000000000000001238f6f51c5af8bfbd8b9dca509123afcf3c5bb8c0647ae4c345a1f442ffffffd00000000000000000000000000000000000000000000000000000000000000000d600ea3f3305f6eb3c0032d61575517d4768cf470396615136194e1967a56091f707f0e1aa2bedd11dd4421397dbcf496b60ae3e8aabb10fd840b8b0bf2070a000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        bytes memory sismoMessage =
            hex"00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000b2261736461736461736422000000000000000000000000000000000000000000";
        address worldcoinSignal = 0xB7142104EDb2B4599F4da6EB19DE148390D13135;
        uint256 worldcoinRoot = 0x13838d57de47c87895ba3cd8c030d6006667690e7755efbd8c3fd23432873016;
        uint256 worldCoinNullifierHash = 0x077ee8437a5612c74fc5ae4293a6ebc50632c7e7c9114aa4b0155c7be2adfe81;
        uint256[8] memory worldcoinProof = [
            0x0e6de0ece83d6f3b0c034b4654e7bfe5254b83d32c5a2fc01bfe2e376d191a53,
            0x1f8d83837b60a4ca08e8fed8a1c67b503787cd0f2dfe67a7b6f051269ee44f9b,
            0x09e2684479d4494ad1c56634a95c6557f75bdd88465b13280fd3627610b60e19,
            0x1105d4149ba7bb327aac4fa65a176986d0ad7749ccadc422d1eb76ee2ccdf82c,
            0x3013f13f813ee043a50b10821c12c53a2073e7acd09b79992c39501fca32a32d,
            0x20ff5db2db15fc26a6e0628a5f7599d0a6611670bdc9d006aec8fe0cd1c2ca39,
            0x2fe524a34d5240518121718cf67e61e7e554d4df65957872f2f06b930c56f56c,
            0x1be29f1530090c6e715392e765a1fb11c45721d4270d4b4cad3009ae398b14dd
        ];

        // Check the voting pools
        bytes32 attestation_id = ostraka.vote(
            sismoConnectResponse, sismoMessage, worldcoinSignal, worldcoinRoot, worldCoinNullifierHash, worldcoinProof
        );
    }

    function testAttestVote() public {
        bytes memory sismoMessage = abi.encode(true, url);
        bytes32 attestation_id = ostraka.exposedAttestVote(sismoMessage);
        IEAS eas = IEAS(0x1a5650D0EcbCa349DD84bAFa85790E3e6955eb84);

        Attestation memory attestation = eas.getAttestation(attestation_id);

        assertEq(attestation.data, sismoMessage);
    }
}
